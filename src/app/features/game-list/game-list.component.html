<ng-container *ngIf="groupedView$ | async as groupedView">
  <ion-list *ngIf="!groupedView.grouped">
    <ng-container *ngFor="let game of groupedView.sections[0]?.games || []; trackBy: trackByExternalId">
      <ng-container *ngTemplateOutlet="gameRowTemplate; context: { $implicit: game }"></ng-container>
    </ng-container>

    <ion-item *ngIf="groupedView.totalCount === 0" lines="none">
      <ion-label color="medium">No games match current filters.</ion-label>
    </ion-item>
  </ion-list>

  <ion-accordion-group
    *ngIf="groupedView.grouped && groupedView.totalCount > 0"
    [multiple]="true"
    [value]="expandedSectionKeys"
    (ionChange)="onGroupedAccordionChange($event)"
  >
    <ion-accordion *ngFor="let section of groupedView.sections; trackBy: trackBySectionKey" [value]="section.key">
      <ion-item slot="header" color="light">
        <ion-label>
          <div class="group-header-title">{{ section.title }}</div>
          <div class="group-header-subtitle">{{ getGroupCountLabel(section.games.length) }}</div>
        </ion-label>
      </ion-item>
      <div slot="content">
        <ion-list>
          <ng-container *ngFor="let game of section.games; trackBy: trackByExternalId">
            <ng-container *ngTemplateOutlet="gameRowTemplate; context: { $implicit: game }"></ng-container>
          </ng-container>
        </ion-list>
      </div>
    </ion-accordion>
  </ion-accordion-group>

  <ion-list *ngIf="groupedView.grouped && groupedView.totalCount === 0">
    <ion-item lines="none">
      <ion-label color="medium">No games match current filters.</ion-label>
    </ion-item>
  </ion-list>
</ng-container>

<ng-template #gameRowTemplate let-game let-fromSimilarDetailSection="fromSimilarDetailSection">
  <ion-item-sliding #slidingItem [disabled]="selectionModeActive">
    <ion-item
      lines="full"
      button
      detail="false"
      [class.game-row-selected]="isGameSelected(getGameKey(game))"
      (click)="onGameRowClick(game, fromSimilarDetailSection === true)"
      (touchstart)="onRowPressStart(game)"
      (touchend)="onRowPressEnd()"
      (touchcancel)="onRowPressEnd()"
      (mousedown)="onRowPressStart(game)"
      (mouseup)="onRowPressEnd()"
      (mouseleave)="onRowPressEnd()"
    >
      <ion-icon
        *ngIf="getStatusIconName(game) as statusIconName"
        class="status-icon"
        [name]="statusIconName"
        [style.color]="getStatusIconColor(game)"
        aria-hidden="true"
      ></ion-icon>
      <div *ngIf="getRating(game) as rating" class="rating-indicator">
        <ion-icon name="star" aria-hidden="true"></ion-icon>
        <span>{{ rating }}</span>
      </div>
      <div *ngIf="formatRowMainHours(game.hltbMainHours) as mainHours" class="hltb-main-indicator">
        {{ mainHours }}
      </div>

      <div slot="start" class="game-art">
        <img [src]="getRowCoverUrl(game)" [alt]="game.title" (error)="onImageError($event)" />
      </div>

      <ion-label>
        <h2>{{ game.title }}</h2>
        <ion-badge class="game-type-badge" *ngIf="getGameTypeBadgeLabel(game) as gameTypeBadgeLabel">
          {{ gameTypeBadgeLabel }}
        </ion-badge>
        <p>{{ game.releaseYear || 'Unknown year' }}</p>
        <p>{{ getPlatformLabel(game.platform, game.platformIgdbId) }}</p>
        <div class="game-tags" *ngIf="game.tags && game.tags.length > 0">
          <ion-badge
            *ngFor="let tag of game.tags"
            [style.--background]="tag.color"
            [style.color]="getTagTextColor(tag.color)"
          >
            {{ tag.name }}
          </ion-badge>
        </div>
      </ion-label>
    </ion-item>

    <ion-item-options side="end" *ngIf="!selectionModeActive" (ionSwipe)="onActionsOptionSwipe(game, slidingItem, $event)">
      <ion-item-option
        (click)="openRowActionsPopover(game, $event, slidingItem)"
      >
        Options
      </ion-item-option>
    </ion-item-options>
  </ion-item-sliding>
</ng-template>

<ion-popover
  [isOpen]="isRowActionsPopoverOpen"
  [event]="rowActionsPopoverEvent"
  reference="event"
  [arrow]="false"
  side="bottom"
  alignment="end"
  (didDismiss)="onRowActionsPopoverDismiss()"
>
  <ng-template>
    <ion-content>
      <ion-list lines="none">
        <ion-item button detail="false" (click)="rowActionsGame && openStatusForGameFromPopover(rowActionsGame)">
          Set status
        </ion-item>
        <ion-item button detail="false" (click)="rowActionsGame && openRatingForGameFromPopover(rowActionsGame)">
          Set rating
        </ion-item>
        <ion-item button detail="false" (click)="rowActionsGame && openTagsForGameFromPopover(rowActionsGame)">
          Set tags
        </ion-item>
        <ion-item button detail="false" (click)="rowActionsGame && moveGameFromPopover(rowActionsGame)">
          Move to {{ getOtherListLabel() }}
        </ion-item>
        <ion-item button detail="false" color="danger" (click)="rowActionsGame && removeGameFromPopover(rowActionsGame)">
          Delete
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-popover>

<ion-modal [isOpen]="isGameDetailModalOpen" (didDismiss)="closeGameDetailModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start" *ngIf="detailNavigationStack.length > 0">
          <ion-button fill="clear" aria-label="Back to previous game" (click)="goBackInDetailNavigation()">
            <ion-icon name="chevron-back" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>{{ selectedGame?.title || 'Game Details' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button
            fill="clear"
            aria-label="Game detail actions"
            [id]="getDetailActionsTriggerId()"
          >
            <ion-icon name="ellipsis-horizontal" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" aria-label="Close game details" (click)="closeGameDetailModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-popover [id]="getDetailActionsPopoverId()" [trigger]="getDetailActionsTriggerId()" triggerAction="click">
      <ng-template>
        <ion-content>
          <ion-list lines="none">
            <ion-item button detail="false" (click)="refreshSelectedGameMetadataFromPopover()">
              Refresh metadata
            </ion-item>
            <ion-item button detail="false" (click)="refreshSelectedGameCompletionTimesFromPopover()">
              Update HLTB data
            </ion-item>
            <ion-item button detail="false" (click)="openImagePickerFromPopover()">
              Update image
            </ion-item>
            <ion-item button detail="false" (click)="openFixMatchFromPopover()">
              Fix game match
            </ion-item>
            <ion-item button detail="false" color="danger" (click)="deleteSelectedGameFromPopover()">
              Delete
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-popover>

    <ion-content #detailContent *ngIf="selectedGame as game" class="detail-content">
      <div class="detail-content-inner">
        <app-game-detail-content
          [game]="getDetailGamePayload(game)"
          context="library"
          [statusOptions]="statusOptions"
          [ratingOptions]="ratingOptions"
          (statusChange)="onSelectedGameStatusChange($event)"
          (clearStatus)="clearSelectedGameStatus()"
          (ratingChange)="onSelectedGameRatingChange($event)"
          (clearRating)="clearSelectedGameRating()"
          (openTags)="openSelectedGameTagsFromDetail()"
          (developerClick)="onDetailDeveloperClick()"
          (seriesClick)="onDetailSeriesClick()"
          (franchiseClick)="onDetailFranchiseClick()"
          (publisherClick)="onDetailPublisherClick()"
        ></app-game-detail-content>

        <ion-list lines="full">
          <ion-list-header class="similar-games-header">
            <ion-label>Similar Games In Your Library</ion-label>
          </ion-list-header>
          <ion-item *ngIf="isSimilarLibraryGamesLoading">
            <ion-spinner slot="start" name="crescent"></ion-spinner>
            <ion-label>Loading similar games...</ion-label>
          </ion-item>
          <ion-item *ngIf="!isSimilarLibraryGamesLoading && similarLibraryGames.length === 0">
            <ion-label color="medium">No similar games found in your library.</ion-label>
          </ion-item>
          <ng-container *ngIf="!isSimilarLibraryGamesLoading && similarLibraryGames.length > 0">
            <ng-container *ngFor="let similarGame of similarLibraryGames; trackBy: trackByExternalId">
              <ng-container *ngTemplateOutlet="gameRowTemplate; context: { $implicit: similarGame, fromSimilarDetailSection: true }"></ng-container>
            </ng-container>
          </ng-container>
        </ion-list>
      </div>

      <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="detail-shortcuts-fab">
        <ion-fab-button aria-label="Open web shortcuts">
          <ion-icon name="search" aria-hidden="true"></ion-icon>
        </ion-fab-button>
        <ion-fab-list side="start">
          <ion-fab-button
            *ngIf="shouldShowOpenManualButton"
            class="shortcut-manual"
            aria-label="Open game manual PDF"
            (click)="openManualPdf()"
          >
            <ion-icon name="document-text" aria-hidden="true"></ion-icon>
          </ion-fab-button>
          <ion-fab-button
            *ngIf="shouldShowFindManualButton"
            class="shortcut-manual-find"
            aria-label="Find game manual PDF"
            (click)="openManualPickerModal()"
          >
            <ion-icon name="search" aria-hidden="true"></ion-icon>
          </ion-fab-button>
          <ion-fab-button class="shortcut-google" aria-label="Search on Google" (click)="openShortcutSearch('google')">
            <ion-icon name="logo-google" aria-hidden="true"></ion-icon>
          </ion-fab-button>
          <ion-fab-button class="shortcut-youtube" aria-label="Search on YouTube" (click)="openShortcutSearch('youtube')">
            <ion-icon name="logo-youtube" aria-hidden="true"></ion-icon>
          </ion-fab-button>
          <ion-fab-button class="shortcut-wikipedia" aria-label="Search on Wikipedia" (click)="openShortcutSearch('wikipedia')">
            <span class="shortcut-text" aria-hidden="true">W</span>
          </ion-fab-button>
          <ion-fab-button class="shortcut-gamefaqs" aria-label="Search on GameFAQs" (click)="openShortcutSearch('gamefaqs')">
            <span class="shortcut-text" aria-hidden="true">G</span>
          </ion-fab-button>
        </ion-fab-list>
      </ion-fab>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isManualPickerModalOpen" (didDismiss)="closeManualPickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Find Manual</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" aria-label="Close find manual" (click)="closeManualPickerModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-item>
        <ion-searchbar
          [value]="manualPickerQuery"
          (ionInput)="onManualPickerQueryInput($event)"
          placeholder="Search manuals"
        ></ion-searchbar>
      </ion-item>
      <ion-item lines="none">
        <ion-button expand="block" [disabled]="isManualPickerLoading" (click)="runManualPickerSearch()">
          {{ isManualPickerLoading ? 'Searching...' : 'Search' }}
        </ion-button>
      </ion-item>

      <ion-item *ngIf="manualPickerError" lines="none">
        <ion-label [color]="manualCatalogUnavailable ? 'warning' : 'medium'">{{ manualPickerError }}</ion-label>
      </ion-item>

      <ion-item
        *ngIf="manualResolvedSource === 'override' && selectedGame"
        lines="none"
      >
        <ion-button color="warning" fill="outline" expand="block" (click)="clearManualMatchOverride()">
          Clear Custom Match
        </ion-button>
      </ion-item>

      <ion-list lines="full">
        <ion-item button detail="false" *ngFor="let candidate of manualPickerResults" (click)="applyManualMatch(candidate)">
          <ion-label>
            <h2>{{ candidate.fileName }}</h2>
            <p>{{ candidate.relativePath }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isMetadataPickerModalOpen" (didDismiss)="closeMetadataPickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ metadataPickerTitle }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeMetadataPickerModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-list lines="full">
        <ion-item>
          <ion-select
            [label]="metadataPickerFieldLabel"
            labelPlacement="stacked"
            [placeholder]="'Choose ' + metadataPickerFieldLabel.toLowerCase()"
            [value]="metadataPickerSelection || undefined"
            (ionChange)="onMetadataPickerSelectionChange($any($event).detail.value)"
          >
            <ion-select-option *ngFor="let option of metadataPickerOptions" [value]="option">
              {{ option }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </ion-list>
      <div class="actions">
        <ion-button expand="block" [disabled]="!metadataPickerSelection" (click)="applySelectedMetadataFilterFromPicker()">
          Apply Filter
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isFixMatchModalOpen" (didDismiss)="closeFixMatchModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Fix Game Match</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeFixMatchModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <app-game-search
        [listType]="listType"
        actionMode="select"
        [initialQuery]="fixMatchInitialQuery"
        [initialPlatformIgdbId]="fixMatchInitialPlatformIgdbId"
        (matchSelected)="onFixMatchSelected($event)"
      ></app-game-search>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isImagePickerModalOpen" (didDismiss)="closeImagePickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Update Box Art</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeImagePickerModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-item lines="none">
        <ion-searchbar
          [value]="imagePickerQuery"
          placeholder="Search box art"
          show-clear-button="focus"
          (ionInput)="onImagePickerQueryChange($event)"
        ></ion-searchbar>
        <ion-button slot="end" [disabled]="isImagePickerLoading" (click)="runImagePickerSearch()">Search</ion-button>
      </ion-item>

      <div class="picker-state" *ngIf="isImagePickerLoading">
        <ion-spinner name="crescent"></ion-spinner>
      </div>

      <p class="picker-state ion-text-center" *ngIf="!isImagePickerLoading && imagePickerError">
        {{ imagePickerError }}
      </p>

      <p class="picker-state ion-text-center" *ngIf="!isImagePickerLoading && !imagePickerError && imagePickerResults.length === 0">
        No 2D box art found.
      </p>

      <ion-grid *ngIf="!isImagePickerLoading && imagePickerResults.length > 0">
        <ion-row>
          <ion-col size="4" size-md="3" *ngFor="let imageUrl of imagePickerResults">
            <ion-button fill="clear" class="box-art-option" (click)="applySelectedImage(imageUrl)">
              <img [src]="imageUrl" alt="Box art option" />
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isHltbPickerModalOpen" (didDismiss)="closeHltbPickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Select HLTB Match</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeHltbPickerModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-item lines="none">
        <ion-searchbar
          [value]="hltbPickerQuery"
          placeholder="Search HLTB"
          show-clear-button="focus"
          (ionInput)="onHltbPickerQueryChange($event)"
        ></ion-searchbar>
        <ion-button slot="end" [disabled]="isHltbPickerLoading" (click)="runHltbPickerSearch()">Search</ion-button>
      </ion-item>

      <div class="picker-state" *ngIf="isHltbPickerLoading">
        <ion-spinner name="crescent"></ion-spinner>
      </div>

      <p class="picker-state ion-text-center" *ngIf="!isHltbPickerLoading && hltbPickerError">
        {{ hltbPickerError }}
      </p>

      <p class="picker-state ion-text-center" *ngIf="hasHltbPickerSearched && !isHltbPickerLoading && !hltbPickerError && hltbPickerResults.length === 0">
        No HLTB results found.
      </p>

      <ion-list *ngIf="!isHltbPickerLoading && hltbPickerResults.length > 0">
        <ion-item button detail="false" *ngFor="let candidate of hltbPickerResults" (click)="applySelectedHltbCandidate(candidate)">
          <ion-thumbnail slot="start" *ngIf="candidate.imageUrl">
            <img [src]="candidate.imageUrl" alt="HLTB result cover" />
          </ion-thumbnail>
          <ion-label>
            <h2>{{ candidate.title }}</h2>
            <p>
              {{ candidate.releaseYear || 'Unknown year' }}
              <span *ngIf="candidate.platform"> · {{ candidate.platform }}</span>
            </p>
            <p>
              Main: {{ candidate.hltbMainHours ?? '?' }}h ·
              Main + Extra: {{ candidate.hltbMainExtraHours ?? '?' }}h ·
              Completionist: {{ candidate.hltbCompletionistHours ?? '?' }}h
            </p>
          </ion-label>
        </ion-item>
      </ion-list>

      <ion-item lines="none">
        <ion-button
          expand="block"
          fill="outline"
          [disabled]="isHltbPickerLoading"
          (click)="useOriginalHltbLookup()"
        >
          Use Original Match
        </ion-button>
      </ion-item>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isRatingModalOpen" (didDismiss)="closeRatingModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Set Rating</ion-title>
        <ion-buttons slot="start">
          <ion-button color="danger" fill="clear" (click)="markRatingForClear()">Clear</ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="closeRatingModal()">Cancel</ion-button>
          <ion-button (click)="saveRatingFromModal()">Save</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-text color="medium">
        <p>Choose a rating for {{ ratingTargetGame?.title || 'this game' }}.</p>
      </ion-text>

      <ion-range
        class="rating-range"
        min="1"
        max="5"
        step="1"
        [value]="ratingDraft"
        [snaps]="true"
        [ticks]="true"
        [pin]="true"
        (ionChange)="onRatingRangeChange($event)"
      >
        <ion-icon slot="start" name="star-outline" aria-hidden="true"></ion-icon>
        <ion-icon slot="end" name="star" aria-hidden="true"></ion-icon>
      </ion-range>

      <ion-note color="danger" *ngIf="clearRatingOnSave">
        Rating will be cleared when saved.
      </ion-note>
    </ion-content>
  </ng-template>
</ion-modal>
