<ng-container *ngIf="groupedView$ | async as groupedView">
  <ion-list *ngIf="!groupedView.grouped">
    <ng-container *ngFor="let game of groupedView.sections[0]?.games || []; trackBy: trackByExternalId">
      <ng-container *ngTemplateOutlet="gameRowTemplate; context: { $implicit: game }"></ng-container>
    </ng-container>

    <ion-item *ngIf="groupedView.totalCount === 0" lines="none">
      <ion-label color="medium">No games match current filters.</ion-label>
    </ion-item>
  </ion-list>

  <ion-accordion-group
    *ngIf="groupedView.grouped && groupedView.totalCount > 0"
    [multiple]="true"
    [value]="getExpandedGroupValues(groupedView.sections)"
  >
    <ion-accordion *ngFor="let section of groupedView.sections" [value]="section.key">
      <ion-item slot="header" color="light">
        <ion-label>
          <div class="group-header-title">{{ section.title }}</div>
          <div class="group-header-subtitle">{{ getGroupCountLabel(section.games.length) }}</div>
        </ion-label>
      </ion-item>
      <div slot="content">
        <ion-list>
          <ng-container *ngFor="let game of section.games; trackBy: trackByExternalId">
            <ng-container *ngTemplateOutlet="gameRowTemplate; context: { $implicit: game }"></ng-container>
          </ng-container>
        </ion-list>
      </div>
    </ion-accordion>
  </ion-accordion-group>

  <ion-list *ngIf="groupedView.grouped && groupedView.totalCount === 0">
    <ion-item lines="none">
      <ion-label color="medium">No games match current filters.</ion-label>
    </ion-item>
  </ion-list>
</ng-container>

<ng-template #gameRowTemplate let-game>
  <ion-item button detail="false" (click)="openGameDetail(game)">
    <div slot="start" class="game-art">
      <img [src]="game.coverUrl || 'assets/icon/favicon.png'" [alt]="game.title" (error)="onImageError($event)" />
    </div>

    <ion-label>
      <h2>{{ game.title }}</h2>
      <p>{{ game.releaseYear || 'Unknown year' }}</p>
      <p>{{ game.platform || 'Unknown platform' }}</p>
      <div class="game-tags" *ngIf="game.tags && game.tags.length > 0">
        <ion-badge
          *ngFor="let tag of game.tags"
          [style.--background]="tag.color"
          [style.color]="getTagTextColor(tag.color)"
        >
          {{ tag.name }}
        </ion-badge>
      </div>
    </ion-label>

    <ion-button
      slot="end"
      fill="clear"
      aria-label="Game actions"
      [id]="getActionsTriggerId(game)"
      (click)="onActionsButtonClick($event)"
    >
      <ion-icon name="ellipsis-horizontal" slot="icon-only"></ion-icon>
    </ion-button>

    <ion-popover [trigger]="getActionsTriggerId(game)" triggerAction="click">
      <ng-template>
        <ion-content>
          <ion-list lines="none">
            <ion-item button detail="false" (click)="openTagsForGameFromPopover(game)">
              Tags
            </ion-item>
            <ion-item button detail="false" (click)="moveGameFromPopover(game)">
              Move to {{ getOtherListLabel() }}
            </ion-item>
            <ion-item button detail="false" color="danger" (click)="removeGameFromPopover(game)">
              Delete
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-popover>
  </ion-item>
</ng-template>

<ion-modal [isOpen]="isGameDetailModalOpen" (didDismiss)="closeGameDetailModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ selectedGame?.title || 'Game Details' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button
            fill="clear"
            aria-label="Game detail actions"
            [id]="getDetailActionsTriggerId()"
          >
            <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button (click)="closeGameDetailModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-popover [trigger]="getDetailActionsTriggerId()" triggerAction="click">
      <ng-template>
        <ion-content>
          <ion-list lines="none">
            <ion-item button detail="false" (click)="openSelectedGameTagsFromPopover()">
              Tags
            </ion-item>
            <ion-item button detail="false" (click)="refreshSelectedGameMetadataFromPopover()">
              Refresh metadata
            </ion-item>
            <ion-item button detail="false" (click)="openImagePickerFromPopover()">
              Update image
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-popover>

    <ion-content *ngIf="selectedGame as game">
      <div class="detail-cover">
        <img [src]="game.coverUrl || 'assets/icon/favicon.png'" [alt]="game.title" (error)="onImageError($event)" />
      </div>

      <ion-list lines="full">
        <ion-item>
          <ion-label>
            <h2>Title</h2>
            <p>{{ game.title }}</p>
          </ion-label>
        </ion-item>
        <ion-item>
          <ion-label>
            <h2>Platform</h2>
            <p>{{ game.platform || 'Unknown' }}</p>
          </ion-label>
        </ion-item>
        <ion-item>
          <ion-label>
            <h2>Release Date</h2>
            <p>{{ formatDate(game.releaseDate) }}</p>
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-button expand="block" (click)="openSelectedGameTagsFromDetail()">Tags</ion-button>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isImagePickerModalOpen" (didDismiss)="closeImagePickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Update Box Art</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeImagePickerModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <ion-item lines="none">
        <ion-searchbar
          [value]="imagePickerQuery"
          placeholder="Search box art"
          show-clear-button="focus"
          (ionInput)="onImagePickerQueryChange($event)"
        ></ion-searchbar>
        <ion-button slot="end" (click)="runImagePickerSearch()">Search</ion-button>
      </ion-item>

      <div class="picker-state" *ngIf="isImagePickerLoading">
        <ion-spinner name="crescent"></ion-spinner>
      </div>

      <p class="picker-state ion-text-center" *ngIf="!isImagePickerLoading && imagePickerError">
        {{ imagePickerError }}
      </p>

      <p class="picker-state ion-text-center" *ngIf="!isImagePickerLoading && !imagePickerError && imagePickerResults.length === 0">
        No 2D box art found.
      </p>

      <ion-grid *ngIf="!isImagePickerLoading && imagePickerResults.length > 0">
        <ion-row>
          <ion-col size="4" size-md="3" *ngFor="let imageUrl of imagePickerResults">
            <ion-button fill="clear" class="box-art-option" (click)="applySelectedImage(imageUrl)">
              <img [src]="imageUrl" alt="Box art option" />
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-content>
  </ng-template>
</ion-modal>
