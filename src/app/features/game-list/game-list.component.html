@if (groupedView$ | async; as groupedView) {
  @if (!groupedView.grouped && groupedView.totalCount > 0) {
    <cdk-virtual-scroll-viewport
      class="game-list-virtual-viewport"
      style="height: 100%; width: 100%"
      [itemSize]="virtualRowHeight"
      [minBufferPx]="virtualMinBufferPx"
      [maxBufferPx]="virtualMaxBufferPx"
    >
      <ion-list>
        <ng-container
          *cdkVirtualFor="
            let game of groupedView.sections[0]?.games || [];
            trackBy: trackByExternalId
          "
        >
          <ng-container
            *ngTemplateOutlet="gameRowTemplate; context: { $implicit: game }"
          ></ng-container>
        </ng-container>
      </ion-list>
    </cdk-virtual-scroll-viewport>
  }
  @if (!groupedView.grouped && groupedView.totalCount === 0) {
    <ion-list>
      <ion-item lines="none">
        <ion-label color="medium">No games match current filters.</ion-label>
      </ion-item>
    </ion-list>
  }
  @if (groupedView.grouped && groupedView.totalCount > 0) {
    <ion-accordion-group
      [multiple]="true"
      [value]="expandedSectionKeys"
      (ionChange)="onGroupedAccordionChange($event)"
    >
      @for (section of groupedView.sections; track trackBySectionKey($index, section)) {
        <ion-accordion [value]="section.key">
          <ion-item slot="header" color="light">
            <ion-label>
              <div class="group-header-title">{{ section.title }}</div>
              <div class="group-header-subtitle">
                {{ getGroupCountLabel(section.games.length) }}
              </div>
            </ion-label>
          </ion-item>
          <div slot="content">
            @if (isSectionRendered(section.key)) {
              <div class="group-section-content">
                <ion-list>
                  @for (game of section.games; track trackByExternalId($index, game)) {
                    <ng-container
                      *ngTemplateOutlet="gameRowTemplate; context: { $implicit: game }"
                    ></ng-container>
                  }
                </ion-list>
              </div>
            }
          </div>
        </ion-accordion>
      }
    </ion-accordion-group>
  }
  @if (groupedView.grouped && groupedView.totalCount === 0) {
    <ion-list>
      <ion-item lines="none">
        <ion-label color="medium">No games match current filters.</ion-label>
      </ion-item>
    </ion-list>
  }
}
<div style="height: var(--game-list-bottom-inset, 0px)" aria-hidden="true"></div>

<ng-template #gameRowTemplate let-game let-fromSimilarDetailSection="fromSimilarDetailSection">
  <ion-item-sliding #slidingItem [disabled]="selectionModeActive">
    <ion-item
      lines="full"
      button
      detail="false"
      [class.game-row-selected]="isGameSelected(getGameKey(game))"
      (click)="onGameRowClick(game, fromSimilarDetailSection === true)"
    >
      @if (getStatusIconName(game); as statusIconName) {
        <ion-icon
          class="status-icon"
          [name]="statusIconName"
          [style.color]="getStatusIconColor(game)"
          aria-hidden="true"
        ></ion-icon>
      }
      @if (getRating(game); as rating) {
        <div class="rating-indicator">
          <ion-icon name="star" aria-hidden="true"></ion-icon>
          <span>{{ rating }}</span>
        </div>
      }
      @if (getRowHltbHoursLabel(game); as mainHours) {
        <div class="row-metadata-indicators">
          <div class="hltb-main-indicator">
            {{ mainHours }}
          </div>
          @if (hasValidRowMetacriticScore(game)) {
            <div class="metacritic-score-indicator" [ngClass]="getRowMetacriticBadgeClass(game)">
              {{ getRowMetacriticScore(game) }}
            </div>
          }
        </div>
      } @else if (hasValidRowMetacriticScore(game)) {
        <div class="row-metadata-indicators">
          <div class="metacritic-score-indicator" [ngClass]="getRowMetacriticBadgeClass(game)">
            {{ getRowMetacriticScore(game) }}
          </div>
        </div>
      }

      <div slot="start" class="game-art">
        <img
          [src]="getRowCoverUrl(game)"
          [alt]="getGameDisplayTitle(game)"
          loading="lazy"
          decoding="async"
          (error)="onImageError($event, game)"
        />
      </div>

      <ion-label>
        <h2>{{ getGameDisplayTitle(game) }}</h2>
        @if (getGameTypeBadgeLabel(game); as gameTypeBadgeLabel) {
          <ion-badge class="game-type-badge">
            {{ gameTypeBadgeLabel }}
          </ion-badge>
        }
        <p>{{ game.releaseYear || 'Unknown year' }}</p>
        <p>{{ getGameDisplayPlatformLabel(game) }}</p>
        @if (game.tags && game.tags.length > 0) {
          <div class="game-tags">
            @for (tag of game.tags; track tag) {
              <ion-badge
                [style.--background]="tag.color"
                [style.color]="getTagTextColor(tag.color)"
              >
                {{ tag.name }}
              </ion-badge>
            }
          </div>
        }
      </ion-label>
    </ion-item>

    @if (!selectionModeActive) {
      <ion-item-options side="end" (ionSwipe)="onActionsOptionSwipe(game, slidingItem, $event)">
        <ion-item-option (click)="openRowActionsPopover(game, $event, slidingItem)">
          Options
        </ion-item-option>
      </ion-item-options>
    }
  </ion-item-sliding>
</ng-template>

<ion-popover
  [isOpen]="isRowActionsPopoverOpen"
  [event]="rowActionsPopoverEvent"
  reference="event"
  [arrow]="false"
  side="bottom"
  alignment="end"
  (didDismiss)="onRowActionsPopoverDismiss()"
>
  <ng-template>
    <ion-content>
      <ion-list lines="none">
        <ion-item
          button
          detail="false"
          (click)="rowActionsGame && openStatusForGameFromPopover(rowActionsGame)"
        >
          Set status
        </ion-item>
        <ion-item
          button
          detail="false"
          (click)="rowActionsGame && openRatingForGameFromPopover(rowActionsGame)"
        >
          Set rating
        </ion-item>
        <ion-item
          button
          detail="false"
          (click)="rowActionsGame && openTagsForGameFromPopover(rowActionsGame)"
        >
          Set tags
        </ion-item>
        <ion-item
          button
          detail="false"
          (click)="rowActionsGame && moveGameFromPopover(rowActionsGame)"
        >
          Move to {{ getOtherListLabel() }}
        </ion-item>
        <ion-item
          button
          detail="false"
          color="danger"
          (click)="rowActionsGame && removeGameFromPopover(rowActionsGame)"
        >
          Delete
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-popover>

<ion-modal
  class="desktop-fullscreen-modal"
  #gameDetailModal
  [isOpen]="isGameDetailModalOpen"
  [canDismiss]="canDismissGameDetailModal"
  [focusTrap]="!isEditMetadataModalOpen"
  (didDismiss)="onGameDetailModalDidDismiss()"
>
  <ng-template>
    <ion-header [translucent]="true">
      <ion-toolbar>
        @if (detailNavigationStack.length > 0) {
          <ion-buttons slot="start">
            <ion-button
              fill="clear"
              aria-label="Back to previous game"
              (click)="goBackInDetailNavigation()"
            >
              <ion-icon name="chevron-back" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-buttons>
        }
        <ion-title>{{
          (selectedGame ? getGameDisplayTitle(selectedGame) : '') || 'Game Details'
        }}</ion-title>
        <ion-buttons slot="end">
          <ion-button
            fill="clear"
            aria-label="Game detail actions"
            [id]="getDetailActionsTriggerId()"
          >
            <ion-icon name="ellipsis-horizontal" slot="icon-only"></ion-icon>
          </ion-button>
          <ion-button fill="clear" aria-label="Close game details" (click)="closeGameDetailModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-popover
      [id]="getDetailActionsPopoverId()"
      [trigger]="getDetailActionsTriggerId()"
      triggerAction="click"
    >
      <ng-template>
        <ion-content>
          <ion-list lines="none">
            <ion-item button detail="false" (click)="refreshSelectedGameMetadataFromPopover()">
              Refresh metadata
            </ion-item>
            <ion-item
              button
              detail="false"
              (click)="refreshSelectedGameCompletionTimesFromPopover()"
            >
              Update HLTB data
            </ion-item>
            <ion-item button detail="false" (click)="refreshSelectedGameMetacriticFromPopover()">
              Update Metacritic data
            </ion-item>
            <ion-item button detail="false" (click)="openFixHltbMatchFromPopover()">
              Fix HLTB match
            </ion-item>
            <ion-item button detail="false" (click)="openFixMetacriticMatchFromPopover()">
              Fix Metacritic match
            </ion-item>
            <ion-item button detail="false" (click)="openImagePickerFromPopover()">
              Update image
            </ion-item>
            <ion-item button detail="false" (click)="openFixMatchFromPopover()">
              Fix IGDB match
            </ion-item>
            <ion-item button detail="false" (click)="openEditMetadataFromPopover()">
              Edit metadata
            </ion-item>
            <ion-item
              button
              detail="false"
              color="danger"
              (click)="deleteSelectedGameFromPopover()"
            >
              Delete
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-popover>

    @if (selectedGame; as game) {
      @if (isDesktopDetailLayout) {
        <ion-split-pane class="detail-notes-split-pane" [contentId]="detailPrimaryPaneContentId">
          @if (isNotesOpen) {
            <ion-menu
              class="detail-notes-menu"
              side="end"
              [contentId]="detailPrimaryPaneContentId"
              [menuId]="notesMenuId"
              [swipeGesture]="false"
            >
              <ng-container [ngTemplateOutlet]="notesPanelTemplate"></ng-container>
            </ion-menu>
          }
          <ng-container
            *ngTemplateOutlet="detailPrimaryPaneTemplate; context: { $implicit: game }"
          ></ng-container>
        </ion-split-pane>
      } @else {
        <ng-container
          *ngTemplateOutlet="detailPrimaryPaneTemplate; context: { $implicit: game }"
        ></ng-container>
      }
    }
  </ng-template>
</ion-modal>

<ng-template #detailPrimaryPaneTemplate let-game>
  <ion-content
    #detailContent
    class="detail-content"
    [class.gs-safe-bottom-with-offset]="!isDesktopDetailLayout"
    [id]="detailPrimaryPaneContentId"
    [fullscreen]="true"
    appAutoContentOffsets
  >
    <div class="detail-content-inner">
      <app-game-detail-content
        [game]="getDetailGamePayload(game)"
        context="library"
        [statusOptions]="statusOptions"
        [ratingOptions]="ratingOptions"
        (statusChange)="onSelectedGameStatusChange($event)"
        (clearStatus)="clearSelectedGameStatus()"
        (ratingChange)="onSelectedGameRatingChange($event)"
        (clearRating)="clearSelectedGameRating()"
        (openTags)="openSelectedGameTagsFromDetail()"
        (developerClick)="onDetailDeveloperClick()"
        (seriesClick)="onDetailSeriesClick()"
        (franchiseClick)="onDetailFranchiseClick()"
        (genreClick)="onDetailGenreClick()"
        (publisherClick)="onDetailPublisherClick()"
      >
        <ion-list lines="full" detail-secondary-content>
          <ion-list-header class="similar-games-header">
            <ion-label>Similar Games In Your Library</ion-label>
          </ion-list-header>
          @if (isSimilarLibraryGamesLoading) {
            <ion-item>
              <ion-spinner slot="start" name="crescent"></ion-spinner>
              <ion-label>Loading similar games...</ion-label>
            </ion-item>
          }
          @if (!isSimilarLibraryGamesLoading && similarLibraryGames.length === 0) {
            <ion-item>
              <ion-label color="medium">No similar games found in your library.</ion-label>
            </ion-item>
          }
          @if (!isSimilarLibraryGamesLoading && similarLibraryGames.length > 0) {
            @for (
              similarGame of similarLibraryGames;
              track trackByExternalId($index, similarGame)
            ) {
              <ng-container
                *ngTemplateOutlet="
                  gameRowTemplate;
                  context: { $implicit: similarGame, fromSimilarDetailSection: true }
                "
              ></ng-container>
            }
          }
        </ion-list>
      </app-game-detail-content>
    </div>
    <ion-fab
      #detailShortcutsFab
      slot="fixed"
      vertical="bottom"
      horizontal="end"
      class="detail-shortcuts-fab"
    >
      <ion-fab-button size="small" aria-label="Open web shortcuts">
        <ion-icon name="globe" aria-hidden="true"></ion-icon>
      </ion-fab-button>
      <ion-fab-list side="top" (click)="closeDetailShortcutsFab()">
        @if (shouldShowNotesShortcut) {
          <ion-fab-button
            class="shortcut-notes"
            color="deep-ocean"
            aria-label="Open notes editor"
            (click)="openNotesEditor()"
          >
            <ion-icon name="document-text" aria-hidden="true"></ion-icon>
          </ion-fab-button>
        }
        @if (shouldShowOpenManualButton) {
          <ion-fab-button
            class="shortcut-manual"
            color="ocean"
            aria-label="Open game manual PDF"
            (click)="openManualPdf()"
          >
            <ion-icon name="book" aria-hidden="true"></ion-icon>
          </ion-fab-button>
        }
        @if (shouldShowFindManualButton) {
          <ion-fab-button
            class="shortcut-manual-find"
            color="dark-gray"
            aria-label="Find game manual PDF"
            (click)="openManualPickerModal()"
          >
            <ion-icon name="search" aria-hidden="true"></ion-icon>
          </ion-fab-button>
        }
        <ion-fab-button
          class="shortcut-google"
          color="forest"
          aria-label="Search on Google"
          (click)="openShortcutSearch('google')"
        >
          <ion-icon name="logo-google" aria-hidden="true"></ion-icon>
        </ion-fab-button>
        <ion-fab-button
          class="shortcut-youtube"
          color="firetruck"
          aria-label="Search on YouTube"
          (click)="openShortcutSearch('youtube')"
        >
          <ion-icon name="logo-youtube" aria-hidden="true"></ion-icon>
        </ion-fab-button>
        <ion-fab-button
          class="shortcut-wikipedia"
          color="white"
          aria-label="Search on Wikipedia"
          (click)="openShortcutSearch('wikipedia')"
        >
          <span class="shortcut-text" aria-hidden="true">W</span>
        </ion-fab-button>
        <ion-fab-button
          class="shortcut-gamefaqs"
          color="royal"
          aria-label="Search on GameFAQs"
          (click)="openShortcutSearch('gamefaqs')"
        >
          <span class="shortcut-text" aria-hidden="true">G</span>
        </ion-fab-button>
      </ion-fab-list>
    </ion-fab>
  </ion-content>
</ng-template>

<ng-template #noteEditorCoreTemplate>
  <tiptap-editor class="detail-note-editor" [editor]="notesEditorInstance"></tiptap-editor>
</ng-template>

<ng-template #noteEditorToolbarTemplate>
  <ion-buttons slot="start">
    <ion-button
      [fill]="getNotesToolbarButtonFill('bold')"
      aria-label="Bold"
      (click)="applyNotesToolbar('bold')"
    >
      <i class="ri-bold" aria-hidden="true"></i>
    </ion-button>
    <ion-button
      [fill]="getNotesToolbarButtonFill('italic')"
      aria-label="Italic"
      (click)="applyNotesToolbar('italic')"
    >
      <i class="ri-italic" aria-hidden="true"></i>
    </ion-button>
    <ion-button
      [fill]="getNotesToolbarButtonFill('underline')"
      aria-label="Underline"
      (click)="applyNotesToolbar('underline')"
    >
      <i class="ri-underline" aria-hidden="true"></i>
    </ion-button>
    <ion-button
      [fill]="getNotesToolbarButtonFill('bullet')"
      aria-label="Bullet list"
      (click)="applyNotesToolbar('bullet')"
    >
      <i class="ri-list-unordered" aria-hidden="true"></i>
    </ion-button>
    <ion-button
      [fill]="getNotesToolbarButtonFill('number')"
      aria-label="Numbered list"
      (click)="applyNotesToolbar('number')"
    >
      <i class="ri-list-ordered-2" aria-hidden="true"></i>
    </ion-button>
    <ion-button
      [fill]="getNotesToolbarButtonFill('check')"
      aria-label="Checklist"
      (click)="applyNotesToolbar('check')"
    >
      <i class="ri-list-check-3" aria-hidden="true"></i>
    </ion-button>
    <ion-button
      [fill]="getNotesToolbarButtonFill('details')"
      aria-label="Details"
      (click)="applyNotesToolbar('details')"
    >
      <i class="ri-t-box-line" aria-hidden="true"></i>
    </ion-button>
  </ion-buttons>
</ng-template>

<ng-template #notesPanelTemplate>
  <ion-header>
    <ion-toolbar>
      <ion-title>Notes</ion-title>
      <ion-buttons slot="end">
        <ion-button fill="clear" (click)="closeNotesEditor()">Close</ion-button>
      </ion-buttons>
    </ion-toolbar>
    <ion-toolbar class="detail-notes-toolbar">
      <ng-container [ngTemplateOutlet]="noteEditorToolbarTemplate"></ng-container>
    </ion-toolbar>
  </ion-header>
  <ion-content class="detail-notes-content">
    <ng-container [ngTemplateOutlet]="noteEditorCoreTemplate"></ng-container>
  </ion-content>
</ng-template>

<ion-modal
  [isOpen]="isNotesModalOpen"
  [canDismiss]="canDismissNotesModal"
  (didDismiss)="onNotesModalDidDismiss()"
>
  <ng-template>
    <ng-container [ngTemplateOutlet]="notesPanelTemplate"></ng-container>
  </ng-template>
</ion-modal>

<input
  #customCoverFileInput
  style="display: none"
  type="file"
  accept="image/*"
  (change)="onCustomCoverFileSelected($event)"
/>

<ion-modal
  [isOpen]="isEditMetadataModalOpen"
  [presentingElement]="gameDetailModalElement"
  (didDismiss)="closeEditMetadataModal()"
>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Edit Metadata</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" (click)="closeEditMetadataModal()"> Close </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="gs-safe-bottom">
      <ion-list lines="full">
        <ion-item>
          <ion-input
            label="Game name"
            labelPlacement="stacked"
            [value]="editMetadataTitle"
            placeholder="Game name"
            (ionInput)="onEditMetadataTitleChange($event)"
          ></ion-input>
        </ion-item>
        <ion-item lines="none">
          <ion-button
            fill="outline"
            color="medium"
            [disabled]="isEditMetadataSaving"
            (click)="resetEditMetadataTitle()"
          >
            Reset Name
          </ion-button>
        </ion-item>
        <ion-item>
          <ion-select
            label="Platform"
            labelPlacement="stacked"
            interface="action-sheet"
            [value]="editMetadataPlatformIgdbId"
            placeholder="Default platform"
            (ionChange)="onEditMetadataPlatformChange($any($event).detail.value)"
          >
            <ion-select-option [value]="null">Default platform</ion-select-option>
            @for (platformOption of editMetadataPlatformOptions; track platformOption) {
              <ion-select-option [value]="platformOption.id">
                {{ getPlatformLabel(platformOption.name, platformOption.id) }}
              </ion-select-option>
            }
          </ion-select>
        </ion-item>
        <ion-item lines="none">
          <ion-button
            fill="outline"
            color="medium"
            [disabled]="isEditMetadataSaving"
            (click)="resetEditMetadataPlatform()"
          >
            Reset Platform
          </ion-button>
        </ion-item>
        <ion-item lines="none">
          <ion-button
            expand="block"
            fill="outline"
            [disabled]="isEditMetadataSaving"
            (click)="uploadCustomImageFromEditMetadata()"
          >
            Upload custom image
          </ion-button>
        </ion-item>
        <ion-item lines="none">
          <ion-button
            expand="block"
            fill="outline"
            color="medium"
            [disabled]="isEditMetadataSaving || !selectedGame?.customCoverUrl"
            (click)="resetCustomImageFromEditMetadata()"
          >
            Reset to default image
          </ion-button>
        </ion-item>
        <ion-item lines="none">
          <ion-button size="default" [disabled]="isEditMetadataSaving" (click)="saveEditMetadata()">
            {{ isEditMetadataSaving ? 'Saving...' : 'Save' }}
          </ion-button>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isManualPickerModalOpen" (didDismiss)="closeManualPickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Find Manual</ion-title>
        <ion-buttons slot="end">
          <ion-button
            fill="clear"
            aria-label="Close find manual"
            (click)="closeManualPickerModal()"
          >
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="gs-safe-bottom">
      <ion-item>
        <ion-searchbar
          [value]="manualPickerQuery"
          (ionInput)="onManualPickerQueryInput($event)"
          placeholder="Search manuals"
        ></ion-searchbar>
      </ion-item>
      <ion-item lines="none">
        <ion-button
          expand="block"
          [disabled]="isManualPickerLoading"
          (click)="runManualPickerSearch()"
        >
          {{ isManualPickerLoading ? 'Searching...' : 'Search' }}
        </ion-button>
      </ion-item>

      @if (manualPickerError) {
        <ion-item lines="none">
          <ion-label [color]="manualCatalogUnavailable ? 'warning' : 'medium'">{{
            manualPickerError
          }}</ion-label>
        </ion-item>
      }

      @if (manualResolvedSource === 'override' && selectedGame) {
        <ion-item lines="none">
          <ion-button
            color="warning"
            fill="outline"
            expand="block"
            (click)="clearManualMatchOverride()"
          >
            Clear Custom Match
          </ion-button>
        </ion-item>
      }

      <ion-list lines="full">
        @for (candidate of manualPickerResults; track candidate) {
          <ion-item button detail="false" (click)="applyManualMatch(candidate)">
            <ion-label>
              <h2>{{ candidate.fileName }}</h2>
              <p>{{ candidate.relativePath }}</p>
            </ion-label>
          </ion-item>
        }
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isFixMatchModalOpen" (didDismiss)="closeFixMatchModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Fix Game Match</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeFixMatchModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="gs-safe-bottom">
      <app-game-search
        [listType]="listType"
        actionMode="select"
        [initialQuery]="fixMatchInitialQuery"
        [initialPlatformIgdbId]="fixMatchInitialPlatformIgdbId"
        (matchSelected)="onFixMatchSelected($event)"
      ></app-game-search>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isImagePickerModalOpen" (didDismiss)="closeImagePickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Update Box Art</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeImagePickerModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding gs-safe-bottom">
      <ion-item lines="none">
        <ion-searchbar
          [value]="imagePickerQuery"
          placeholder="Search box art"
          show-clear-button="focus"
          (ionInput)="onImagePickerQueryChange($event)"
        ></ion-searchbar>
        <ion-button slot="end" [disabled]="isImagePickerLoading" (click)="runImagePickerSearch()"
          >Search</ion-button
        >
      </ion-item>

      @if (isImagePickerLoading) {
        <div class="picker-state">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      }

      @if (!isImagePickerLoading && imagePickerError) {
        <p class="picker-state ion-text-center">
          {{ imagePickerError }}
        </p>
      }

      @if (!isImagePickerLoading && imagePickerResults.length > 0) {
        <ion-list-header>
          <ion-label>TheGamesDB Results</ion-label>
        </ion-list-header>
      }

      @if (
        !isImagePickerLoading &&
        !imagePickerError &&
        imagePickerResults.length === 0 &&
        !imagePickerIgdbCoverUrl
      ) {
        <p class="picker-state ion-text-center">No 2D box art found.</p>
      }

      @if (!isImagePickerLoading && imagePickerResults.length > 0) {
        <ion-grid>
          <ion-row>
            @for (imageUrl of imagePickerResults; track imageUrl) {
              <ion-col size="4" size-md="3">
                <ion-button
                  fill="clear"
                  class="box-art-option"
                  (click)="applySelectedImage(imageUrl)"
                >
                  <img [src]="imageUrl" alt="Box art option" />
                </ion-button>
              </ion-col>
            }
          </ion-row>
        </ion-grid>
      }

      @if (!isImagePickerLoading && imagePickerIgdbCoverUrl) {
        <ion-list-header>
          <ion-label>IGDB Image</ion-label>
        </ion-list-header>
      }

      @if (!isImagePickerLoading && imagePickerIgdbCoverUrl) {
        <ion-grid>
          <ion-row>
            <ion-col size="4" size-md="3">
              <ion-button
                fill="clear"
                class="box-art-option"
                (click)="applySelectedImage(imagePickerIgdbCoverUrl!)"
              >
                <img [src]="imagePickerIgdbCoverUrl" alt="IGDB box art option" />
              </ion-button>
            </ion-col>
          </ion-row>
        </ion-grid>
      }
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isHltbPickerModalOpen" (didDismiss)="closeHltbPickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Select HLTB Match</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeHltbPickerModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding gs-safe-bottom">
      <ion-item lines="none">
        <ion-searchbar
          [value]="hltbPickerQuery"
          placeholder="Search HLTB"
          show-clear-button="focus"
          (ionInput)="onHltbPickerQueryChange($event)"
        ></ion-searchbar>
        <ion-button slot="end" [disabled]="isHltbPickerLoading" (click)="runHltbPickerSearch()"
          >Search</ion-button
        >
      </ion-item>

      @if (isHltbPickerLoading) {
        <div class="picker-state">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      }

      @if (!isHltbPickerLoading && hltbPickerError) {
        <p class="picker-state ion-text-center">
          {{ hltbPickerError }}
        </p>
      }

      @if (
        hasHltbPickerSearched &&
        !isHltbPickerLoading &&
        !hltbPickerError &&
        hltbPickerResults.length === 0
      ) {
        <p class="picker-state ion-text-center">No HLTB results found.</p>
      }

      @if (!isHltbPickerLoading && hltbPickerResults.length > 0) {
        <ion-list>
          @for (candidate of hltbPickerResults; track candidate) {
            <ion-item button detail="false" (click)="applySelectedHltbCandidate(candidate)">
              @if (candidate.imageUrl) {
                <ion-thumbnail slot="start">
                  <img [src]="candidate.imageUrl" alt="HLTB result cover" />
                </ion-thumbnail>
              }
              <ion-label>
                <h2>{{ candidate.title }}</h2>
                <p>
                  {{ candidate.releaseYear || 'Unknown year' }}
                  @if (candidate.platform) {
                    <span> 路 {{ candidate.platform }}</span>
                  }
                </p>
                <p>
                  Main: {{ candidate.hltbMainHours ?? '?' }}h 路 Main + Extra:
                  {{ candidate.hltbMainExtraHours ?? '?' }}h 路 Completionist:
                  {{ candidate.hltbCompletionistHours ?? '?' }}h
                </p>
              </ion-label>
            </ion-item>
          }
        </ion-list>
      }

      <ion-item lines="none">
        <ion-button
          expand="block"
          fill="outline"
          [disabled]="isHltbPickerLoading"
          (click)="useOriginalHltbLookup()"
        >
          Use Original Match
        </ion-button>
      </ion-item>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isMetacriticPickerModalOpen" (didDismiss)="closeMetacriticPickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Select Metacritic Match</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeMetacriticPickerModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding gs-safe-bottom">
      <ion-item lines="none">
        <ion-searchbar
          [value]="metacriticPickerQuery"
          placeholder="Search Metacritic"
          show-clear-button="focus"
          (ionInput)="onMetacriticPickerQueryChange($event)"
        ></ion-searchbar>
        <ion-button
          slot="end"
          [disabled]="isMetacriticPickerLoading"
          (click)="runMetacriticPickerSearch()"
          >Search</ion-button
        >
      </ion-item>

      @if (isMetacriticPickerLoading) {
        <div class="picker-state">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      }

      @if (!isMetacriticPickerLoading && metacriticPickerError) {
        <p class="picker-state ion-text-center">
          {{ metacriticPickerError }}
        </p>
      }

      @if (
        hasMetacriticPickerSearched &&
        !isMetacriticPickerLoading &&
        !metacriticPickerError &&
        metacriticPickerResults.length === 0
      ) {
        <p class="picker-state ion-text-center">No Metacritic results found.</p>
      }

      @if (!isMetacriticPickerLoading && metacriticPickerResults.length > 0) {
        <ion-list>
          @for (candidate of metacriticPickerResults; track candidate) {
            <ion-item button detail="false" (click)="applySelectedMetacriticCandidate(candidate)">
              @if (candidate.imageUrl) {
                <div slot="start" class="candidate-thumbnail">
                  <img [src]="candidate.imageUrl" alt="Metacritic result cover" />
                </div>
              }
              <ion-label>
                <h2>{{ candidate.title }}</h2>
                <p>
                  {{ candidate.releaseYear || 'Unknown year' }}
                  @if (candidate.platform) {
                    <span> 路 {{ candidate.platform }}</span>
                  }
                </p>
                <p>
                  Score: <strong>{{ candidate.metacriticScore ?? '?' }}</strong>
                </p>
              </ion-label>
            </ion-item>
          }
        </ion-list>
      }

      <ion-item lines="none">
        <ion-button
          expand="block"
          fill="outline"
          [disabled]="isMetacriticPickerLoading"
          (click)="useOriginalMetacriticLookup()"
        >
          Use Original Match
        </ion-button>
      </ion-item>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isRatingModalOpen" (didDismiss)="closeRatingModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Set Rating</ion-title>
        <ion-buttons slot="start">
          <ion-button color="danger" fill="clear" (click)="markRatingForClear()">Clear</ion-button>
        </ion-buttons>
        <ion-buttons slot="end">
          <ion-button (click)="closeRatingModal()">Cancel</ion-button>
          <ion-button (click)="saveRatingFromModal()">Save</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding gs-safe-bottom">
      <ion-text color="medium">
        <p>Choose a rating for {{ ratingTargetGame?.title || 'this game' }}.</p>
      </ion-text>

      <ion-range
        class="rating-range"
        min="1"
        max="5"
        step="1"
        [value]="ratingDraft"
        [snaps]="true"
        [ticks]="true"
        [pin]="true"
        (ionChange)="onRatingRangeChange($event)"
      >
        <ion-icon slot="start" name="star-outline" aria-hidden="true"></ion-icon>
        <ion-icon slot="end" name="star" aria-hidden="true"></ion-icon>
      </ion-range>

      @if (clearRatingOnSave) {
        <ion-note color="danger"> Rating will be cleared when saved. </ion-note>
      }
    </ion-content>
  </ng-template>
</ion-modal>
