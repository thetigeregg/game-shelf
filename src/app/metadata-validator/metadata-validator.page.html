<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start" [collapse]="true">
      <ion-back-button defaultHref="/settings"></ion-back-button>
    </ion-buttons>
    <ion-title>Metadata Validator</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-list class="validator-list">
    <ion-list-header>
      <ion-label>Scope</ion-label>
    </ion-list-header>

    <ion-item>
      <ion-select
        label="Game list"
        labelPlacement="stacked"
        interface="popover"
        placeholder="Select game list"
        [value]="selectedListType"
        (ionChange)="onListTypeChange($any($event).detail.value)"
      >
        <ion-select-option value="collection">Collection</ion-select-option>
        <ion-select-option value="wishlist">Wishlist</ion-select-option>
      </ion-select>
    </ion-item>

    <ion-item>
      <ion-select
        label="Missing metadata filters"
        labelPlacement="stacked"
        interface="popover"
        [multiple]="true"
        [value]="selectedMissingFilters"
        (ionChange)="onMissingFiltersChange($any($event).detail.value)"
      >
        @for (option of missingFilterOptions; track option) {
          <ion-select-option [value]="option.value">
            {{ option.label }}
          </ion-select-option>
        }
      </ion-select>
    </ion-item>

    <ion-item lines="none">
      <ion-label color="medium">{{ getDisplayedGamesLabel() }} in current result</ion-label>
      <ion-note slot="end">{{ selectedGamesCount }} selected</ion-note>
    </ion-item>

    <div class="bulk-actions-row">
      <ion-button fill="outline" (click)="toggleSelectAllDisplayed()">
        {{ isAllDisplayedSelected() ? 'Unselect all' : 'Select all' }}
      </ion-button>
      <ion-button
        fill="outline"
        color="medium"
        [disabled]="selectedGamesCount === 0"
        (click)="clearSelection()"
      >
        Clear
      </ion-button>
    </div>

    <div class="bulk-actions-row">
      <ion-button
        [disabled]="selectedGamesCount === 0 || isBulkRefreshingHltb"
        (click)="refreshHltbForSelectedGames()"
      >
        @if (isBulkRefreshingHltb) {
          <ion-spinner name="crescent" slot="start"></ion-spinner>
        }
        Bulk HLTB
      </ion-button>
      <ion-button
        [disabled]="selectedGamesCount === 0 || isBulkRefreshingReview"
        (click)="refreshReviewForSelectedGames()"
      >
        @if (isBulkRefreshingReview) {
          <ion-spinner name="crescent" slot="start"></ion-spinner>
        }
        Bulk Review
      </ion-button>
      <ion-button
        color="secondary"
        [disabled]="selectedGamesCount === 0 || isBulkRefreshingImage"
        (click)="refreshImageForSelectedGames()"
      >
        @if (isBulkRefreshingImage) {
          <ion-spinner name="crescent" slot="start"></ion-spinner>
        }
        Bulk Image
      </ion-button>
    </div>
  </ion-list>

  <ion-list class="validator-list">
    <ion-list-header>
      <ion-label>Games</ion-label>
    </ion-list-header>

    @if (filteredGames$ | async; as games) {
      @for (game of games; track trackByGameKey($index, game)) {
        <ion-item>
          <ion-checkbox
            slot="start"
            [checked]="isGameSelected(game)"
            (ionChange)="toggleGameSelection(game)"
          ></ion-checkbox>
          <ion-label>
            <h2>{{ game.title }}</h2>
            <p>{{ getPlatformLabel(game) }} · {{ game.releaseYear || 'Unknown year' }}</p>
            <div class="validator-badges">
              <ion-badge [color]="hasHltbMetadata(game) ? 'success' : 'warning'">
                HLTB {{ hasHltbMetadata(game) ? 'OK' : 'Missing' }}
              </ion-badge>
              <ion-badge [color]="hasReviewMetadata(game) ? 'success' : 'warning'">
                Review {{ hasReviewMetadata(game) ? 'OK' : 'Missing' }}
              </ion-badge>
              @if (!isNonPcImageNotApplicable(game)) {
                <ion-badge [color]="isNonPcTheGamesDbImagePresent(game) ? 'success' : 'warning'">
                  Image {{ isNonPcTheGamesDbImagePresent(game) ? 'TheGamesDB' : 'Missing' }}
                </ion-badge>
              }
              @if (isNonPcImageNotApplicable(game)) {
                <ion-badge color="medium"> Image N/A (PC) </ion-badge>
              }
            </div>
          </ion-label>
          <div slot="end" class="row-actions">
            <ion-button fill="outline" (click)="refreshHltbForGame(game)"> HLTB </ion-button>
            <ion-button fill="outline" (click)="refreshReviewForGame(game)"> Review </ion-button>
            <ion-button
              fill="outline"
              color="secondary"
              [disabled]="isNonPcImageNotApplicable(game)"
              (click)="refreshImageForGame(game)"
            >
              Image
            </ion-button>
          </div>
        </ion-item>
      }
      @if (games.length === 0) {
        <ion-item lines="none">
          <ion-label color="medium">
            {{
              !selectedListType
                ? 'Select Collection or Wishlist to load games.'
                : selectedMissingFilters.length === 0
                  ? 'Select at least one missing metadata filter to display games.'
                  : 'No games match current metadata filters.'
            }}
          </ion-label>
        </ion-item>
      }
    }
  </ion-list>
</ion-content>

<ion-modal [isOpen]="isHltbPickerModalOpen" (didDismiss)="closeHltbPickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Select HLTB Match</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeHltbPickerModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div class="picker-search-row">
        <ion-searchbar
          [value]="hltbPickerQuery"
          placeholder="Search HLTB"
          show-clear-button="focus"
          (ionInput)="onHltbPickerQueryChange($event)"
        ></ion-searchbar>
        <ion-button [disabled]="isHltbPickerLoading" (click)="runHltbPickerSearch()"
          >Search</ion-button
        >
      </div>

      @if (isHltbPickerLoading) {
        <div class="picker-state">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      }

      @if (!isHltbPickerLoading && hltbPickerError) {
        <p class="picker-state ion-text-center">
          {{ hltbPickerError }}
        </p>
      }

      @if (!isHltbPickerLoading && !hltbPickerError && hltbPickerResults.length === 0) {
        <p class="picker-state ion-text-center">No HLTB results found.</p>
      }

      @if (!isHltbPickerLoading && hltbPickerResults.length > 0) {
        <ion-list>
          @for (candidate of hltbPickerResults; track candidate) {
            <ion-item button detail="false" (click)="applySelectedHltbCandidate(candidate)">
              @if (candidate.imageUrl) {
                <ion-thumbnail slot="start">
                  <img [src]="candidate.imageUrl" alt="HLTB result cover" />
                </ion-thumbnail>
              }
              <ion-label>
                <h2>{{ candidate.title }}</h2>
                <p>
                  {{ candidate.releaseYear || 'Unknown year' }}
                  @if (candidate.platform) {
                    <span> · {{ candidate.platform }}</span>
                  }
                </p>
                <p>
                  Main: {{ candidate.hltbMainHours ?? '?' }}h · Main + Extra:
                  {{ candidate.hltbMainExtraHours ?? '?' }}h · Completionist:
                  {{ candidate.hltbCompletionistHours ?? '?' }}h
                </p>
              </ion-label>
            </ion-item>
          }
        </ion-list>
      }

      <div class="picker-action-row">
        <ion-button
          expand="block"
          fill="outline"
          [disabled]="isHltbPickerLoading"
          (click)="useOriginalHltbLookup()"
        >
          Use Original Match
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal [isOpen]="isReviewPickerModalOpen" (didDismiss)="closeReviewPickerModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Select Review Match</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeReviewPickerModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div class="picker-search-row">
        <ion-searchbar
          [value]="reviewPickerQuery"
          placeholder="Search Review"
          show-clear-button="focus"
          (ionInput)="onReviewPickerQueryChange($event)"
        ></ion-searchbar>
        <ion-button [disabled]="isReviewPickerLoading" (click)="runReviewPickerSearch()"
          >Search</ion-button
        >
      </div>

      @if (isReviewPickerLoading) {
        <div class="picker-state">
          <ion-spinner name="crescent"></ion-spinner>
        </div>
      }

      @if (!isReviewPickerLoading && reviewPickerError) {
        <p class="picker-state ion-text-center">
          {{ reviewPickerError }}
        </p>
      }

      @if (!isReviewPickerLoading && !reviewPickerError && reviewPickerResults.length === 0) {
        <p class="picker-state ion-text-center">No review results found.</p>
      }

      @if (!isReviewPickerLoading && reviewPickerResults.length > 0) {
        <ion-list>
          @for (candidate of reviewPickerResults; track candidate) {
            <ion-item button detail="false" (click)="applySelectedReviewCandidate(candidate)">
              @if (candidate.imageUrl) {
                <div slot="start" class="candidate-thumbnail">
                  <img [src]="candidate.imageUrl" alt="Review result cover" />
                </div>
              }
              <ion-label>
                <h2>{{ candidate.title }}</h2>
                <p>
                  {{ candidate.releaseYear || 'Unknown year' }}
                  @if (candidate.platform) {
                    <span> · {{ candidate.platform }}</span>
                  }
                </p>
                <p>
                  Score:
                  <strong>{{ candidate.reviewScore ?? candidate.metacriticScore ?? '?' }}</strong>
                </p>
              </ion-label>
            </ion-item>
          }
        </ion-list>
      }

      <div class="picker-action-row">
        <ion-button
          expand="block"
          fill="outline"
          [disabled]="isReviewPickerLoading"
          (click)="useOriginalReviewLookup()"
        >
          Use Original Match
        </ion-button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
