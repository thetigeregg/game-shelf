import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const scriptDir = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(scriptDir, '..');
const canonicalMapPath = path.resolve(repoRoot, 'config/igdb-to-mobygames-platform-map.json');
const frontendSupportPath = path.resolve(repoRoot, 'src/app/core/utils/mobygames-platform-map.ts');

function toSortedEntries(map) {
  return Object.entries(map)
    .map(([igdbId, mobyId]) => [Number.parseInt(igdbId, 10), Number.parseInt(String(mobyId), 10)])
    .filter(
      ([igdbId, mobyId]) =>
        Number.isInteger(igdbId) && igdbId > 0 && Number.isInteger(mobyId) && mobyId > 0
    )
    .sort((a, b) => a[0] - b[0]);
}

function buildFrontendSupportSource(entries) {
  const lines = entries.map(([igdbId, mobyId]) => `  [${igdbId}, ${mobyId}],`).join('\n');

  return `// This file is auto-generated by scripts/generate-mobygames-platform-artifacts.mjs.
// Do not edit manually.
const IGDB_TO_MOBYGAMES_PLATFORM_ENTRIES: ReadonlyArray<readonly [number, number]> = [
${lines}
] as const;

export const IGDB_TO_MOBYGAMES_PLATFORM_ID_MAP = new Map<number, number>(
  IGDB_TO_MOBYGAMES_PLATFORM_ENTRIES
);

export function resolveMobyGamesPlatformId(
  platformIgdbId: number | null | undefined
): number | null {
  if (!Number.isInteger(platformIgdbId) || (platformIgdbId as number) <= 0) {
    return null;
  }

  return IGDB_TO_MOBYGAMES_PLATFORM_ID_MAP.get(platformIgdbId as number) ?? null;
}
`;
}

async function main() {
  const rawCanonical = await fs.readFile(canonicalMapPath, 'utf8');
  const parsedCanonical = JSON.parse(rawCanonical);

  if (!parsedCanonical || typeof parsedCanonical !== 'object' || Array.isArray(parsedCanonical)) {
    throw new Error(
      'Canonical MobyGames platform map must be an object keyed by IGDB platform id.'
    );
  }

  const entries = toSortedEntries(parsedCanonical);
  if (entries.length === 0) {
    throw new Error('Canonical MobyGames platform map did not yield any valid platform mappings.');
  }

  await fs.writeFile(frontendSupportPath, buildFrontendSupportSource(entries), 'utf8');
}

await main();
