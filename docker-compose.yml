services:
  edge:
    container_name: gameshelf-edge
    build:
      context: .
      dockerfile: edge/Dockerfile
    environment:
      TZ: ${TZ:-Europe/Zurich}
      FEATURE_MGC_IMPORT: ${FEATURE_MGC_IMPORT:-false}
    command: >-
      /bin/sh -c
      "feature_raw=$$(printf '%s' \"$${FEATURE_MGC_IMPORT:-false}\" | tr '[:upper:]' '[:lower:]');
      case \"$$feature_raw\" in 1|true|yes|on) feature_bool=true ;; *) feature_bool=false ;; esac;
      mkdir -p /srv/assets;
      config_path=/srv/assets/runtime-config.js;
      tmp_path=/tmp/runtime-config.js;
      if [ -f \"$$config_path\" ]; then
      grep -v '^window.__GAME_SHELF_RUNTIME_CONFIG__ = Object.assign({}, window.__GAME_SHELF_RUNTIME_CONFIG__, { featureFlags: { showMgcImport:' \"$$config_path\" > \"$$tmp_path\" || true;
      mv \"$$tmp_path\" \"$$config_path\";
      fi;
      printf '%s' \"window.__GAME_SHELF_RUNTIME_CONFIG__ = Object.assign({}, window.__GAME_SHELF_RUNTIME_CONFIG__, { featureFlags: { showMgcImport: $$feature_bool } });\" >> \"$$config_path\";
      echo >> \"$$config_path\";
      exec caddy run --config /etc/caddy/Caddyfile --adapter caddyfile"
    depends_on:
      - api
    ports:
      - '127.0.0.1:8080:8080'
    volumes:
      - ./nas-data/manuals:/manuals:ro
    restart: unless-stopped

  api:
    container_name: gameshelf-api
    build:
      context: .
      dockerfile: server/Dockerfile
    environment:
      TZ: ${TZ:-Europe/Zurich}
      HOST: ${HOST:-0.0.0.0}
      PORT: ${PORT:-3000}
      REQUEST_BODY_LIMIT_BYTES: ${REQUEST_BODY_LIMIT_BYTES:-10485760}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://127.0.0.1:8080,http://localhost:8080}
      REQUIRE_AUTH: ${REQUIRE_AUTH:-true}
      DEBUG_HTTP_LOGS: ${DEBUG_HTTP_LOGS:-}
      API_TOKEN_FILE: ${API_TOKEN_FILE:-/run/secrets/api_token}
      CLIENT_WRITE_TOKENS_FILE: ${CLIENT_WRITE_TOKENS_FILE:-/run/secrets/client_write_tokens}
      DATABASE_URL_FILE: ${DATABASE_URL_FILE:-/run/secrets/database_url}
      IMAGE_CACHE_DIR: ${IMAGE_CACHE_DIR:-/data/images}
      IMAGE_CACHE_TTL_SECONDS: ${IMAGE_CACHE_TTL_SECONDS:-2592000}
      IMAGE_PROXY_TIMEOUT_MS: ${IMAGE_PROXY_TIMEOUT_MS:-12000}
      IMAGE_PROXY_MAX_BYTES: ${IMAGE_PROXY_MAX_BYTES:-8388608}
      IMAGE_PROXY_RATE_LIMIT_WINDOW_MS: ${IMAGE_PROXY_RATE_LIMIT_WINDOW_MS:-60000}
      IMAGE_PROXY_MAX_REQUESTS_PER_WINDOW: ${IMAGE_PROXY_MAX_REQUESTS_PER_WINDOW:-120}
      IMAGE_PURGE_MAX_REQUESTS_PER_WINDOW: ${IMAGE_PURGE_MAX_REQUESTS_PER_WINDOW:-30}
      CACHE_STATS_RATE_LIMIT_WINDOW_MS: ${CACHE_STATS_RATE_LIMIT_WINDOW_MS:-60000}
      CACHE_STATS_MAX_REQUESTS_PER_WINDOW: ${CACHE_STATS_MAX_REQUESTS_PER_WINDOW:-60}
      TWITCH_CLIENT_ID_FILE: ${TWITCH_CLIENT_ID_FILE:-/run/secrets/twitch_client_id}
      TWITCH_CLIENT_SECRET_FILE: ${TWITCH_CLIENT_SECRET_FILE:-/run/secrets/twitch_client_secret}
      THEGAMESDB_API_KEY_FILE: ${THEGAMESDB_API_KEY_FILE:-/run/secrets/thegamesdb_api_key}
      HLTB_SCRAPER_BASE_URL: ${HLTB_SCRAPER_BASE_URL:-http://hltb-scraper:8788}
      HLTB_SCRAPER_TOKEN_FILE: ${HLTB_SCRAPER_TOKEN_FILE:-/run/secrets/hltb_scraper_token}
      FIREBASE_SERVICE_ACCOUNT_JSON_FILE: ${FIREBASE_SERVICE_ACCOUNT_JSON_FILE:-/run/secrets/firebase_service_account_json}
      RELEASE_MONITOR_ENABLED: ${RELEASE_MONITOR_ENABLED:-true}
      RELEASE_MONITOR_INTERVAL_SECONDS: ${RELEASE_MONITOR_INTERVAL_SECONDS:-900}
      RELEASE_MONITOR_BATCH_SIZE: ${RELEASE_MONITOR_BATCH_SIZE:-100}
      RELEASE_MONITOR_DEBUG_LOGS: ${RELEASE_MONITOR_DEBUG_LOGS:-false}
      HLTB_PERIODIC_REFRESH_YEARS: ${HLTB_PERIODIC_REFRESH_YEARS:-3}
      HLTB_PERIODIC_REFRESH_DAYS: ${HLTB_PERIODIC_REFRESH_DAYS:-30}
      HLTB_CACHE_ENABLE_STALE_WHILE_REVALIDATE: ${HLTB_CACHE_ENABLE_STALE_WHILE_REVALIDATE:-true}
      HLTB_CACHE_FRESH_TTL_SECONDS: ${HLTB_CACHE_FRESH_TTL_SECONDS:-604800}
      HLTB_CACHE_STALE_TTL_SECONDS: ${HLTB_CACHE_STALE_TTL_SECONDS:-7776000}
      MANUALS_DIR: ${MANUALS_DIR:-/data/manuals}
      MANUALS_PUBLIC_BASE_URL: ${MANUALS_PUBLIC_BASE_URL:-/manuals}
    depends_on:
      - postgres
      - hltb-scraper
    volumes:
      - ./nas-data/image-cache:/data/images
      - ./nas-data/manuals:/data/manuals:ro
      - ${SECRETS_HOST_DIR:-./nas-secrets}:/run/secrets:ro
    restart: unless-stopped

  postgres:
    container_name: gameshelf-postgres
    image: postgres:16-alpine
    environment:
      TZ: ${TZ:-Europe/Zurich}
      PGTZ: ${TZ:-Europe/Zurich}
      POSTGRES_DB: ${POSTGRES_DB:-gameshelf}
      POSTGRES_USER_FILE: ${POSTGRES_USER_FILE:-/run/secrets/postgres_user}
      POSTGRES_PASSWORD_FILE: ${POSTGRES_PASSWORD_FILE:-/run/secrets/postgres_password}
    volumes:
      - ./nas-data/postgres:/var/lib/postgresql/data
      - ${SECRETS_HOST_DIR:-./nas-secrets}:/run/secrets:ro
    healthcheck:
      test:
        - CMD-SHELL
        - user_file="$${POSTGRES_USER_FILE:-}"; if [ -z "$$user_file" ] || [ ! -r "$$user_file" ]; then echo "POSTGRES_USER_FILE missing/unreadable" >&2; exit 1; fi; user="$$(tr -d '\r\n' < "$$user_file")"; pg_isready -h 127.0.0.1 -U "$$user" -d "$${POSTGRES_DB}" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: unless-stopped

  hltb-scraper:
    container_name: gameshelf-hltb-scraper
    build:
      context: .
      dockerfile: hltb-scraper/Dockerfile
    environment:
      TZ: ${TZ:-Europe/Zurich}
      PORT: ${HLTB_SCRAPER_PORT:-8788}
      HLTB_SCRAPER_TIMEOUT_MS: ${HLTB_SCRAPER_TIMEOUT_MS:-25000}
      HLTB_SCRAPER_BROWSER_IDLE_MS: ${HLTB_SCRAPER_BROWSER_IDLE_MS:-30000}
      HLTB_SCRAPER_TOKEN_FILE: ${HLTB_SCRAPER_TOKEN_FILE:-/run/secrets/hltb_scraper_token}
      DEBUG_HLTB_SCRAPER_LOGS: ${DEBUG_HLTB_SCRAPER_LOGS:-false}
    volumes:
      - ${SECRETS_HOST_DIR:-./nas-secrets}:/run/secrets:ro
    restart: unless-stopped

  backup:
    container_name: gameshelf-backup
    build:
      context: .
      dockerfile: backup/Dockerfile
    environment:
      TZ: ${TZ:-Europe/Zurich}
      PGTZ: ${TZ:-Europe/Zurich}
      PGHOST: postgres
      PGPORT: 5432
      PGDATABASE: ${POSTGRES_DB:-gameshelf}
      PGUSER_FILE: ${PGUSER_FILE:-/run/secrets/postgres_user}
      PGPASSWORD_FILE: ${PGPASSWORD_FILE:-/run/secrets/postgres_password}
      BACKUP_KEEP_COUNT: ${BACKUP_KEEP_COUNT:-14}
      BACKUP_SCHEDULE_TIME: ${BACKUP_SCHEDULE_TIME:-00:00}
      BACKUP_PGDUMP_RETRIES: ${BACKUP_PGDUMP_RETRIES:-3}
      BACKUP_PGDUMP_RETRY_DELAY_SECONDS: ${BACKUP_PGDUMP_RETRY_DELAY_SECONDS:-5}
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ${BACKUP_HOST_DIR:-./nas-data/backups}:/backups
      - ${SECRETS_HOST_DIR:-./nas-secrets}:/run/secrets:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '${BACKUP_CPU_LIMIT:-0.5}'
          memory: '${BACKUP_MEMORY_LIMIT:-512M}'
