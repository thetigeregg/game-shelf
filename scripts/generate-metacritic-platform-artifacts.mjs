import fs from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const scriptDir = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(scriptDir, '..');
const canonicalMapPath = path.resolve(repoRoot, 'config/metacritic-platform-map.json');
const scraperMapPath = path.resolve(
  repoRoot,
  'metacritic-scraper/src/igdb-to-metacritic-platform-map.json'
);
const frontendSupportPath = path.resolve(
  repoRoot,
  'src/app/core/utils/metacritic-platform-support.ts'
);

function stringifyJson(value) {
  return `${JSON.stringify(value, null, 2)}\n`;
}

function toSortedPlatformIds(map) {
  return Object.keys(map)
    .map((value) => Number.parseInt(value, 10))
    .filter((value) => Number.isInteger(value) && value > 0)
    .sort((a, b) => a - b);
}

function buildFrontendSupportSource(platformIds) {
  const idsLiteral = platformIds.join(', ');
  return `// This file is auto-generated by scripts/generate-metacritic-platform-artifacts.mjs.
// Do not edit manually.
const SUPPORTED_IGDB_PLATFORM_IDS = [${idsLiteral}] as const;

export const METACRITIC_SUPPORTED_IGDB_PLATFORM_IDS = new Set<number>(
  SUPPORTED_IGDB_PLATFORM_IDS
);

export function isMetacriticPlatformSupported(
  platformIgdbId: number | null | undefined
): boolean {
  return (
    typeof platformIgdbId === 'number' &&
    Number.isFinite(platformIgdbId) &&
    Number.isInteger(platformIgdbId) &&
    METACRITIC_SUPPORTED_IGDB_PLATFORM_IDS.has(platformIgdbId)
  );
}
`;
}

async function main() {
  const rawCanonical = await fs.readFile(canonicalMapPath, 'utf8');
  const parsedCanonical = JSON.parse(rawCanonical);

  if (!parsedCanonical || typeof parsedCanonical !== 'object' || Array.isArray(parsedCanonical)) {
    throw new Error(
      'Canonical metacritic platform map must be an object keyed by IGDB platform id.'
    );
  }

  const platformIds = toSortedPlatformIds(parsedCanonical);

  await fs.writeFile(scraperMapPath, stringifyJson(parsedCanonical), 'utf8');
  await fs.writeFile(frontendSupportPath, buildFrontendSupportSource(platformIds), 'utf8');
}

await main();
