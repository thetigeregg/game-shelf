services:
  edge:
    container_name: gameshelf-edge
    build:
      context: .
      dockerfile: edge/Dockerfile
    environment:
      TZ: ${TZ:-Europe/Zurich}
      FEATURE_MGC_IMPORT: ${FEATURE_MGC_IMPORT:-false}
      API_TOKEN_FILE: ${API_TOKEN_FILE:-/run/secrets/api_token}
    command: >-
      /bin/sh -c
      "token_file=$${API_TOKEN_FILE:-};
      if [ -n \"$$token_file\" ] && [ -r \"$$token_file\" ]; then
        export API_TOKEN=$$(tr -d '\r\n' < \"$$token_file\");
      fi;
      feature_raw=$$(printf '%s' \"$${FEATURE_MGC_IMPORT:-false}\" | tr '[:upper:]' '[:lower:]');
      case \"$$feature_raw\" in 1|true|yes|on) feature_bool=true ;; *) feature_bool=false ;; esac;
      mkdir -p /srv/assets;
      printf \"window.__GAME_SHELF_RUNTIME_CONFIG__ = Object.assign({}, window.__GAME_SHELF_RUNTIME_CONFIG__, { featureFlags: { showMgcImport: %s } });\n\" \"$$feature_bool\" >> /srv/assets/runtime-config.js;
      exec caddy run --config /etc/caddy/Caddyfile --adapter caddyfile"
    depends_on:
      - api
    ports:
      - '127.0.0.1:8080:8080'
    volumes:
      - ./nas-data/manuals:/manuals:ro
      - ${SECRETS_HOST_DIR:-./nas-secrets}:/run/secrets:ro
    restart: unless-stopped

  api:
    container_name: gameshelf-api
    build:
      context: .
      dockerfile: server/Dockerfile
    environment:
      TZ: ${TZ:-Europe/Zurich}
      HOST: ${HOST:-0.0.0.0}
      PORT: ${PORT:-3000}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://127.0.0.1:8080,http://localhost:8080}
      REQUIRE_AUTH: ${REQUIRE_AUTH:-true}
      API_TOKEN_FILE: ${API_TOKEN_FILE:-/run/secrets/api_token}
      DATABASE_URL_FILE: ${DATABASE_URL_FILE:-/run/secrets/database_url}
      IMAGE_CACHE_DIR: ${IMAGE_CACHE_DIR:-/data/images}
      IMAGE_PROXY_TIMEOUT_MS: ${IMAGE_PROXY_TIMEOUT_MS:-12000}
      IMAGE_PROXY_MAX_BYTES: ${IMAGE_PROXY_MAX_BYTES:-8388608}
      TWITCH_CLIENT_ID_FILE: ${TWITCH_CLIENT_ID_FILE:-/run/secrets/twitch_client_id}
      TWITCH_CLIENT_SECRET_FILE: ${TWITCH_CLIENT_SECRET_FILE:-/run/secrets/twitch_client_secret}
      THEGAMESDB_API_KEY_FILE: ${THEGAMESDB_API_KEY_FILE:-/run/secrets/thegamesdb_api_key}
      HLTB_SCRAPER_BASE_URL: ${HLTB_SCRAPER_BASE_URL:-http://hltb-scraper:8788}
      HLTB_SCRAPER_TOKEN_FILE: ${HLTB_SCRAPER_TOKEN_FILE:-/run/secrets/hltb_scraper_token}
      MANUALS_DIR: ${MANUALS_DIR:-/data/manuals}
      MANUALS_PUBLIC_BASE_URL: ${MANUALS_PUBLIC_BASE_URL:-/manuals}
    depends_on:
      - postgres
      - hltb-scraper
    volumes:
      - ./nas-data/image-cache:/data/images
      - ./nas-data/manuals:/data/manuals:ro
      - ${SECRETS_HOST_DIR:-./nas-secrets}:/run/secrets:ro
    restart: unless-stopped

  postgres:
    container_name: gameshelf-postgres
    image: postgres:16-alpine
    environment:
      TZ: ${TZ:-Europe/Zurich}
      PGTZ: ${TZ:-Europe/Zurich}
      POSTGRES_DB: ${POSTGRES_DB:-gameshelf}
      POSTGRES_USER_FILE: ${POSTGRES_USER_FILE:-/run/secrets/postgres_user}
      POSTGRES_PASSWORD_FILE: ${POSTGRES_PASSWORD_FILE:-/run/secrets/postgres_password}
    volumes:
      - ./nas-data/postgres:/var/lib/postgresql/data
      - ${SECRETS_HOST_DIR:-./nas-secrets}:/run/secrets:ro
    healthcheck:
      test:
        - CMD-SHELL
        - user="$${POSTGRES_USER:-}"; if [ -z "$$user" ] && [ -n "$${POSTGRES_USER_FILE:-}" ] && [ -r "$${POSTGRES_USER_FILE}" ]; then user="$$(tr -d '\r\n' < "$${POSTGRES_USER_FILE}")"; fi; pg_isready -h 127.0.0.1 -U "$$user" -d "$${POSTGRES_DB}" || exit 1
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: unless-stopped

  hltb-scraper:
    container_name: gameshelf-hltb-scraper
    build:
      context: .
      dockerfile: hltb-scraper/Dockerfile
    environment:
      TZ: ${TZ:-Europe/Zurich}
      PORT: ${HLTB_SCRAPER_PORT:-8788}
      HLTB_SCRAPER_TIMEOUT_MS: ${HLTB_SCRAPER_TIMEOUT_MS:-25000}
      HLTB_SCRAPER_TOKEN_FILE: ${HLTB_SCRAPER_TOKEN_FILE:-/run/secrets/hltb_scraper_token}
      DEBUG_HLTB_SCRAPER_LOGS: ${DEBUG_HLTB_SCRAPER_LOGS:-false}
    volumes:
      - ${SECRETS_HOST_DIR:-./nas-secrets}:/run/secrets:ro
    restart: unless-stopped

  backup:
    container_name: gameshelf-backup
    image: postgres:16-alpine
    environment:
      TZ: ${TZ:-Europe/Zurich}
      PGTZ: ${TZ:-Europe/Zurich}
      PGHOST: postgres
      PGPORT: 5432
      PGDATABASE: ${POSTGRES_DB:-gameshelf}
      PGUSER_FILE: ${PGUSER_FILE:-/run/secrets/postgres_user}
      PGPASSWORD_FILE: ${PGPASSWORD_FILE:-/run/secrets/postgres_password}
      BACKUP_KEEP_COUNT: ${BACKUP_KEEP_COUNT:-14}
      BACKUP_SCHEDULE_TIME: ${BACKUP_SCHEDULE_TIME:-00:00}
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ${BACKUP_HOST_DIR:-./nas-data/backups}:/backups
      - ./scripts/backup:/opt/backup:ro
      - ${SECRETS_HOST_DIR:-./nas-secrets}:/run/secrets:ro
    command:
      - /bin/sh
      - -ec
      - /opt/backup/start-cron.sh
    restart: unless-stopped
