<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Explore</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">Explore</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-item lines="full">
    <ion-select
      label="Popularity category"
      labelPlacement="stacked"
      interface="popover"
      placeholder="Select category"
      [value]="selectedPopularityTypeId"
      [disabled]="isLoadingTypes || popularityTypes.length === 0"
      (ionChange)="onPopularityTypeChange($any($event).detail.value)"
    >
      @for (type of popularityTypes; track trackByPopularityTypeId($index, type)) {
        <ion-select-option [value]="type.id">
          {{ type.name }}
        </ion-select-option>
      }
    </ion-select>
  </ion-item>

  @if (isLoadingTypes || isLoadingGames) {
    <div class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  }

  @if (errorMessage.length > 0) {
    <ion-item lines="none">
      <ion-text color="danger">{{ errorMessage }}</ion-text>
    </ion-item>
  }

  @if (!isLoadingTypes && popularityTypes.length === 0 && errorMessage.length === 0) {
    <ion-item lines="none">
      <ion-text color="medium">No popularity categories available.</ion-text>
    </ion-item>
  }

  @if (!isLoadingGames && games.length > 0) {
    <ion-list lines="full">
      @for (item of games; track trackByGameId($index, item)) {
        <ion-item button detail="true" (click)="openGameDetail(item)">
          <div slot="start" class="explore-cover">
            <img
              class="explore-cover-image"
              [src]="item.game.coverUrl || 'assets/icon/placeholder.png'"
              [alt]="item.game.title"
              loading="lazy"
              (error)="onImageError($event)"
            />
          </div>
          <ion-label>
            <h2>{{ item.game.title }}</h2>
            <p>
              {{ getPlatformLabel(item) }}
              @if (item.game.releaseYear) {
                <span> â€¢ {{ item.game.releaseYear }}</span>
              }
            </p>
          </ion-label>
        </ion-item>
      }
    </ion-list>
  }

  @if (
    !isLoadingGames &&
    games.length === 0 &&
    selectedPopularityTypeId !== null &&
    errorMessage.length === 0
  ) {
    <ion-item lines="none">
      <ion-text color="medium">No games found for this category.</ion-text>
    </ion-item>
  }

  <ion-infinite-scroll
    threshold="100px"
    [disabled]="selectedPopularityTypeId === null || isLoadingGames || !hasMore"
    (ionInfinite)="loadMore($event)"
  >
    <ion-infinite-scroll-content
      loadingSpinner="crescent"
      loadingText="Loading more games..."
    ></ion-infinite-scroll-content>
  </ion-infinite-scroll>
</ion-content>

<ion-modal [isOpen]="isGameDetailModalOpen" (didDismiss)="closeGameDetailModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ selectedGameDetail?.title || 'Game Details' }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeGameDetailModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="detail-content">
      <ion-loading
        [isOpen]="isLoadingDetail"
        message="Loading game details..."
        spinner="crescent"
        [backdropDismiss]="false"
      ></ion-loading>

      @if (detailErrorMessage.length > 0) {
        <ion-item lines="none">
          <ion-text color="danger">{{ detailErrorMessage }}</ion-text>
        </ion-item>
      }

      @if (selectedGameDetail; as game) {
        <app-game-detail-content
          [game]="game"
          [context]="detailContext"
          [statusOptions]="statusOptions"
          [ratingOptions]="ratingOptions"
          [showAddToLibraryAction]="detailContext === 'explore'"
          [isAddToLibraryLoading]="isAddToLibraryLoading"
          (addToLibrary)="addSelectedGameToLibrary()"
          (statusChange)="onDetailStatusChange($event)"
          (clearStatus)="clearDetailStatus()"
          (ratingChange)="onDetailRatingChange($event)"
          (clearRating)="clearDetailRating()"
          (openTags)="openDetailTags()"
        ></app-game-detail-content>
      }

      @if (detailContext === 'explore') {
        <ion-fab slot="fixed" vertical="bottom" horizontal="end" class="detail-shortcuts-fab">
          <ion-fab-button aria-label="Open web shortcuts">
            <ion-icon name="search" aria-hidden="true"></ion-icon>
          </ion-fab-button>
          <ion-fab-list side="start">
            <ion-fab-button
              class="shortcut-google"
              aria-label="Search on Google"
              (click)="openShortcutSearch('google')"
            >
              <ion-icon name="logo-google" aria-hidden="true"></ion-icon>
            </ion-fab-button>
            <ion-fab-button
              class="shortcut-youtube"
              aria-label="Search on YouTube"
              (click)="openShortcutSearch('youtube')"
            >
              <ion-icon name="logo-youtube" aria-hidden="true"></ion-icon>
            </ion-fab-button>
            <ion-fab-button
              class="shortcut-wikipedia"
              aria-label="Search on Wikipedia"
              (click)="openShortcutSearch('wikipedia')"
            >
              <span class="shortcut-text" aria-hidden="true">W</span>
            </ion-fab-button>
            <ion-fab-button
              class="shortcut-gamefaqs"
              aria-label="Search on GameFAQs"
              (click)="openShortcutSearch('gamefaqs')"
            >
              <span class="shortcut-text" aria-hidden="true">G</span>
            </ion-fab-button>
          </ion-fab-list>
        </ion-fab>
      }
    </ion-content>
  </ng-template>
</ion-modal>
